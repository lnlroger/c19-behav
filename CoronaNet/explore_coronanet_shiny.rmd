---
title: "CovidNet Dataset Exploration"
author: "Lio"
date: "07/05/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,warning = FALSE)
library("plyr")
library("tidyverse")
library("countrycode")
library("shiny")
library("plotly")
```

## CoronaNet Dataset

The CoronaNet dataset records government responses to the Covid-19 pandemic and underlies the paper 'A Retrospective Bayesian Model for Measuring Covariate Effects on Observed Covid-19 Test and Case Counts' by Cheng et al. (2020). The dataset, paper and all related files and code can be found at https://github.com/saudiwin/corona_tscs.

The dataset is fairly complex, as it covers more than 140 countries and contains about 14,000 government actions since January 2020. In its raw form, it is at the country-day-action level, with several dimensions that characterise each government action. This document seeks to improve the understanding of the dataset in a rather descriptive way, and ultimately to bring it into a form that lends itself to further analysis regarding behavioural factors that influence political response and / or epidemiology of Covid-19. 

```{r import data, echo=FALSE}
dta <- read.csv("coronanet_release.csv") %>%
  mutate(continent = countrycode(ISO_A3, "iso3c", "continent")) %>%
  mutate(region = countrycode(ISO_A3, "iso3c", "region"))
```
## Distribution of reported cases

```{r case counts, echo=FALSE}

# By type ----
dta.barchart.type <- dta %>%
  group_by(type) %>%
  dplyr::summarise(count = n()) 

fig <- plot_ly(
  x = dta.barchart.type$count,
  y = dta.barchart.type$type,
  name = "Types of restrictions",
  type = "bar"
)


fig

```

Most entries describe intervenrions related to health resources, followed by external border restrictions, closure of schools, restriction of non-essential business, and quarantine/lockdown.

Each of these types of events is divided into sub-types. For instance, 'Health resources' breaks down as follows:

```{r type breakdowns, echo=FALSE}

# By sub-type for most frequent types

dta.health.resources <- dta%>%
  filter(type == "Health Resources") %>%
  group_by(type_sub_cat) %>%
  summarise(count = n())

fig <- plot_ly(
  x = dta.health.resources$count,
  y = dta.health.resources$type_sub_cat,
  name = "Types of restrictions",
  type = "bar",
  automargin = TRUE
)

fig <- fig %>% layout(autosize = F)

fig


```

The reports further details about each measure; a potentially important one is whether measures are mandatory or voluntary. Let's have a look for quarantine/lockdowns (note that there are a bunch of categories, I simplify it to mandatory and voluntary):

```{r lockdown compliance, echo=FALSE}

# Types of quarantine (compliance)

dta <- mutate(dta, compliance_binary = ifelse(substr(compliance,1,9) == "Mandatory", "Mandatory",
                                              ifelse(substr(compliance,1,9) == "Voluntary", "Voluntary", NA)))

is.lockdown <- which(dta$type == "Quarantine/Lockdown")

dta.mandatory <- dta%>%
  filter(type == "Quarantine/Lockdown") %>%
  group_by(compliance_binary) %>%
  summarise(count = n())

fig <- plot_ly(
  x = dta.mandatory$count,
  y = dta.mandatory$compliance_binary,
  name = "Mandatory vs voluntary lockdown",
  type = "bar",
  automargin = TRUE
)

fig <- fig %>% layout(autosize = F)

fig


```

There are something like 1000 mandatory lockdowns measures recorded, obviously this doesn't exactly coincide with what we normally consider 'the' lockdown (of which you wouldn't expect more than one per country), so the first challenge is to identify what constitutes a "proper" lockdown.

## Lockdowns by country

A first piece of the puzzle may lie in the distribution of lockdowns measures by country (only 40 countries with the highest number of lockdown measures included in the plot for readability):

```{r lockdowns by country, echo=FALSE}

# Distribution of lockdown announcements by country

lockdown.per.country <- dta[is.lockdown,] %>%
  group_by(country) %>%
  tally() %>%
  arrange(desc(n))

fig <- plot_ly(
  x = lockdown.per.country[1:40,]$country,
  y = lockdown.per.country[1:40,]$n,
  name = "Number of announcements by country",
  type = "bar",
  automargin = TRUE
)

fig <- fig %>% layout(autosize = F)

fig


```

China and the US stick out, I suspect substantial reporting bias. The large number of actions isn't surprising in the federal US however, and in general federalist states will be a bit of a challenge in the analysis / aggregation of the data. Plotted below is the administrative level at which lockdowns / lockdown measures are recorded (globally):

```{r lockdown admin level, echo=FALSE}

# Administrative level of lockdowns

dta <- mutate(dta, level_binary = ifelse(init_country_level %in% c("National", "No, it is at the national level"), 
                                         "National",
                                         ifelse(init_country_level %in% c("Municipal", "Yes, it is at the province/state level"),
                                                "Sub-National",
                                                NA
                                                )))

dta.admin.level <- dta%>%
  filter(type == "Quarantine/Lockdown") %>%
  group_by(level_binary) %>%
  tally()

fig <- plot_ly(
  x = dta.admin.level$n,
  y = dta.admin.level$level_binary,
  name = "Administrative level of lockdown",
  type = "bar",
  automargin = TRUE
)

fig <- fig %>% layout(autosize = F)

fig



```

Indeed, more than half of those measures aren't at the national level.


## Lockdowns over time

Let us also look at when those lockdown measures came into place.

```{r lockdown time, echo=FALSE}

# Distribution of lockdown announcements in time

lockdown.per.day <- dta[is.lockdown,] %>%
  group_by(date_start) %>%
  tally()

fig <- plot_ly(data = lockdown.per.day,
               x = ~date_start,
               y = ~n,
               type = "bar")
fig  


ggplot(lockdown.per.day,mapping = aes(x = as.Date(date_start),y = n)) +
  geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

As expected, there is a bunching around mid- to end-March.

## Policy Activity Index

Cheng et al. (2020) also construct a 'Policy Activity Index' - I am not entirely sure how this is constructed yet and what it is meant to measure. Here is what it looks like:

```{r index, echo = FALSE}

# Index ----

index.daily <- dta %>% # Daily series of index by country
  group_by(country, date_start) %>%
  summarise(index_high = mean(index_high_est, na.rm = TRUE),
            index_median = mean(index_med_est, na.rm = TRUE),
            index_low = mean(index_low_est), na.rm = TRUE,
            continent = first(continent),
            region = first(region)) %>%
  dplyr::arrange(country, date_start) %>%
  filter(as.Date(date_start) < as.Date("2020-04-20")) 

index.daily.wide <- index.daily %>%
  pivot_wider(id_cols = c("country","date_start"),names_from = country, values_from = index_median) %>%
  dplyr::arrange(date_start) %>%
  fill(-date_start, .direction = "down")

fig <- plot_ly()%>%
  layout(title = "Policy index over time",
         xaxis = list(title = ""),
         yaxis = list (title = "") )

ToAdd <- setdiff(colnames(index.daily.wide),"date_start")

for(i in ToAdd){
  fig <- fig %>% add_lines(x = index.daily.wide[["date_start"]], y = index.daily.wide[[i]], name = i)
}

fig <- fig %>% layout(showlegend = FALSE)

fig 

# Index by region

index.daily.region <- index.daily %>%
  group_by(region, date_start) %>%
  summarise(index_high = median(index_high, na.rm = TRUE),
            index_median = median(index_median, na.rm = TRUE),
            index_low = median(index_low), na.rm = TRUE) %>%
  na.omit()

index.daily.region.wide <- index.daily.region %>%
  pivot_wider(id_cols = c("region","date_start"),names_from = region, values_from = index_median) %>%
  dplyr::arrange(date_start) %>%
  fill(-date_start, .direction = "down")

fig <- plot_ly()%>%
  layout(title = "Policy index over time (region)",
         xaxis = list(title = ""),
         yaxis = list (title = "") )

ToAdd <- setdiff(colnames(index.daily.region.wide),"date_start")

for(i in ToAdd){
  fig <- fig %>% add_lines(x = index.daily.region.wide[["date_start"]], y = index.daily.region.wide[[i]], name = i)
}


fig 




```

## Identifying lockdown dates

In order to identify the dates of what we would call a lockdown, I pick the first date a measure came into effect that is categorised as (i) Quarantine / Lockdown and (ii) Mandatory.

```{r compare lockdowns, echo=FALSE}
# Identify 'initial' mandatory lockdown and compare with dates we previously registered ----

first.lockdown <- dta %>%
  filter(type == "Quarantine/Lockdown",
         compliance_binary == "Mandatory") %>%
  group_by(country) %>%
  arrange(as.Date(date_start)) %>%
  mutate(first_lockdown = as.Date(date_start)) %>%
  select(country,first_lockdown) %>%
  slice(1) %>%
  distinct()

fig <- plot_ly(x = first.lockdown$first_lockdown, type = "histogram")

fig


```


